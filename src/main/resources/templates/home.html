<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/head :: head_fragment">
</head>

<body>
	<!-- navbar -->
	<nav th:replace="common/navbar :: nav_fragment">
	</nav>

	<div class="p-3 p-sm-5 mb-4 bg-img"> <!-- Junbotronで背景表示 -->
		<!-- 検索ウインドウ -->
		<div class="container-fluid p-5">
			<div class="row justify-content-center">
				<div class="col-md-5">
					<form method="GET" class="d-flex" th:action="@{/book/search}">
						<input class="form-control me-2 text-center" type="search" name="keyword" placeholder="Search Book..." aria-label="Search" th:value=${keyword}>
						<input type="hidden" name="user" th:value="${user}">
						<button class="btn btn-success" type="submit">Search</button>
					</form>
				</div>
			</div>
		</div>
				
		<!-- 書籍情報の新規登録 -->		
		<form method="GET" th:action="@{/book/newbook(user=${user})}"> <!-- {id}に(id=)を代入 -->
			<input type="hidden" name="user" th:value="${user}">
			<button type="submit" class="btn btn-primary">新しい本を登録する</button> <!-- リクエストパラメータとしてuserを送る -->
		</form>
	</div>

	<!-- ▽▽▽ 書籍情報が1件でもあれば表示 ▽▽▽ -->	
	<div th:unless="${#lists.isEmpty(bookList)}">
		<div class="container-fluid">
			<div class="row">
				<div class="d-grid gap-2 d-md-flex justify-content-md-end">
					<!-- 上位5件表示 -->
					<form method="GET" th:action="@{/}" th:unless="${showFlag} == 0">
					<input type="hidden" name="user" th:value="${user}">
							<button class="btn btn-outline-success" type="submit">人気の本を表示</button>
					</form>
					<!-- 全件表示 -->
					<form method="GET" th:action="@{/book}" th:unless="${showFlag} == 1">
							<input type="hidden" name="user" th:value="${user}">
							<input type="hidden" name="page" th:value="1">
							<button class="btn btn-outline-secondary" type="submit">全ての本を表示</button>
					</form>
				</div>
			</div>
		</div>
		<!-- BookReviewControllerにてModelに格納したlistをユーティリティーオブジェクトを使ってチェックしている -->
		<div class="container-fluid pt-3">
			<!-- 登録/更新完了コメント -->
			<!-- ${complete}はinsertメソッドからRedirectパラメーターとして渡される -->
			<div class="col">
				<p th:if="${complete}" th:text="${complete}" style="color:blue"></p>
			</div>
		
			<table class="table table-bordered table-striped table-hover table-responsive">
				<thead>
					<tr class="text-center table-primary">
						<th scope="col" style="width: 50%">書籍名</th>
						<th scope="col" style="width: 20%">評価</th>
						<th scope="rol" colspan="3" style="width: 30%">各種操作</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="obj : ${bookList}">
						<td th:text="${obj.title}" align="left"></td>
						<!-- 評価をスター表示 -->
						<td class="text-center">
							<div class="row">
								<input class="show-rating rating-loading" name="rate" th:value="${obj.totalevaluation}">
								<label class="col" th:text="'(' + ${obj.totalevaluation} + ')'"></label>
							</div>
						</td>
						<!-- RV登録ボタン -->
						<td class="text-center">
							<form method="GET" th:action="@{/book/{id}/newreview(id=${obj.id})}"><!-- {id}に(id=)を代入 -->
								<input type="hidden" name="user" th:value="${user}">
								<button type="submit" class="btn btn-primary">RV登録</button>
							</form>
						</td>
						<!-- 詳細ボタン -->
						<td class="text-center">
							<form method="GET" th:action="@{/book/detail/{id}(id=${obj.id})}"> <!-- {id}に(id=)を代入 -->
								<input type="hidden" name="user" th:value="${user}">
								<button type="submit" class="btn btn-primary">詳細</button> <!-- リクエストパラメータとしてuserを送る -->
							</form>
						</td>
						<!-- 削除ボタン -->
						<td th:if="${user} == 'admin'" align="center">
							<form method="POST" th:action="@{/book/delete/{id}(id=${obj.id})}"> <!-- {id}に(id=)を代入 -->
								<input type="hidden" name="_method" value="DELETE"> <!-- DELETEメソッドを隠しフィールドで送る -->
								<input type="hidden" name="user" th:value="${user}"> <!-- 隠しフィールドとしてuserを渡す -->
								<button type="submit" class="btn btn-secondary">削除</button>
							</form>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		
		<!-- ページング -->
		<div class="container-fluid">
			<div class="row" th:unless="${showFlag} == 0">
				<div class="d-grid gap-2 d-md-flex justify-content-md-end">
				<nav aria-label="Page navigation book">
						<ul class="pagination">
							<!-- 先頭ページ -->
							<li class="page-item">
						      <a class="page-link" th:unless="${page} == 1" th:href="@{/book(user=${user}, page=1)}">&laquo;</a>
						      <span class="page-link" aria-label="Previous" th:if="${page} == 1">&laquo;</span>
						    </li>
						    <!-- 各ページへのリンクを表示 -->
							<li th:class="(${i}==${page})? 'page-item active' : 'page-item'" th:each='i : ${#numbers.sequence(1, allPages)}'>
								<!-- 現在表示しているページはspan -->
								<span class="page-link" th:if='${i}==${page}' th:text='${i}'>1
									<span class="sr-only">(current)</span>
								</span>
								<!-- 現在表示している以外のページはリンク -->
								<a class="page-link" th:unless='${i}==${page}' th:href="@{/book(user=${user}, page=${i})}">
									<span th:text='${i}'>1</span>
								</a>
							</li>
							<!-- 最後のページ -->
							<li class="page-item">
								<a class="page-link" th:unless="${page} == ${allPages}" th:href="@{/book(user=${user}, page=${allPages})}">&raquo;</a>
								<span class="page-link" th:if="${page} == ${allPages}">&raquo;</span>
							</li>
						</ul>
			     </nav>
			     </div>
		     </div>
		 </div>
	 </div>
	<!-- △△△ 書籍情報が1件でもあれば表示 △△△ -->
	
	<!-- ▽▽▽ 書籍情報が1件もない場合表示 ▽▽▽ -->
	<p th:if="${#lists.isEmpty(bookList)}">登録されている書籍はありません</p>
	<!-- △△△ 書籍情報が1件もない場合表示 △△△ -->
	

    <!-- JSとjQueryの読み込み -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <!-- <script src="js/star-rating.js" type="text/javascript"></script>
    <script src="js/themes/krajee-svg/theme.js"></script> -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/js/star-rating.js" type="text/javascript"></script>

    <!-- optionally if you need to use a theme, then include the theme file as mentioned below -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/themes/krajee-svg/theme.js"></script>
    
    <!-- optionally if you need translation for your language then include locale file as mentioned below (replace LANG.js with your locale specific file) -->
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/js/locales/LANG.js"></script>

    <script>
		$(document).ready(function(){
		    $('.show-rating').rating({displayOnly: true, showCaption: false, step: 0.5, size: "xs"});
		});
	</script>
	
</body>
</html>